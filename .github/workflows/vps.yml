name: VPS

on:
  repository_dispatch:
    types: [create-vps]

jobs:
  ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours max
    steps:
    
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install tools
      run: |
        sudo apt update -y
        sudo apt install -y openssh-server curl wget tar unzip net-tools lsof neofetch tmux
        sudo apt install -y libvirt-clients libvirt-daemon-system qemu-kvm virtinst bridge-utils cloud-image-utils genisoimage
        sudo systemctl enable ssh
        sudo systemctl start ssh

    - name: Set hostname and default folder
      run: |
        echo "Biralo" | sudo tee /etc/hostname
        sudo hostname Biralo
        mkdir -p /home/runner/vps-data
        echo 'cd /home/runner/vps-data' >> ~/.bashrc

    - name: Install tmate & cloudflared
      run: |
        curl -sSL https://raw.githubusercontent.com/tsu-sh/vps/main/install.sh | bash

    - name: Connect Tailscale (optional)
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey ${{ secrets.TS_AUTHKEY }} --hostname=biralo-vps || true

    - name: Restore backup if exists
      run: |
        mkdir -p /home/runner/vps-data
        if curl -s --head https://transfer.sh/biralo-backup.tar.gz | grep "200 OK" > /dev/null; then
          curl -o /tmp/restore.tar.gz https://transfer.sh/biralo-backup.tar.gz
          tar -xzf /tmp/restore.tar.gz -C /home/runner/vps-data
          echo "âœ… Backup restored!"
        else
          echo "âš ï¸ No backup found to restore."
        fi

    - name: Start tmate session
      run: |
        echo "ğŸ” Connect using SSH or Web:"
        echo "SSH will appear below shortly..."
        tmate -F | tee /tmp/tmate.log &
        sleep 10
        grep -Eo 'ssh [^ ]+' /tmp/tmate.log > ssh.txt || true
        grep -Eo 'https://tmate.io/t/[^ ]+' /tmp/tmate.log > web.txt || true

    - name: Print SSH link
      run: |
        echo "ğŸ”— SSH: $(cat ssh.txt)"
        echo "ğŸŒ Web: $(cat web.txt)"

    - name: Backup every 5h55min
      run: |
        sleep 21300  # 5h55m = 21300 seconds
        tar -czf /tmp/biralo-backup.tar.gz -C /home/runner vps-data
        curl --upload-file /tmp/biralo-backup.tar.gz https://transfer.sh/biralo-backup.tar.gz > /tmp/backup-link.txt
        echo "ğŸ§° Backup uploaded: $(cat /tmp/backup-link.txt)"

name: Free VPS with Stable Tailscale + tmate + Backup + Auto Rotation

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout repo (for pushing backup)
        uses: actions/checkout@v4

      - name: Clean old tailscale repo/key if any
        run: |
          sudo rm -f /etc/apt/sources.list.d/tailscale.list
          sudo rm -f /usr/share/keyrings/tailscale-archive-keyring.gpg || true

      - name: Add tailscale repo and GPG key (Ubuntu jammy 22.04)
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list

      - name: Update apt and install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y tailscale tmate git curl jq tar

      - name: Start tailscale with auth key
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          sudo tailscale up --authkey $TS_AUTHKEY --hostname github-vps

      - name: Create user 'biralo' with sudo and password
        run: |
          sudo useradd -m -s /bin/bash biralo || echo "User biralo already exists"
          echo "biralo:biralo" | sudo chpasswd
          sudo usermod -aG sudo biralo
          echo "biralo ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/biralo

      - name: Setup default login dir to /home/biralo/vps-data
        run: |
          sudo mkdir -p /home/biralo/vps-data
          sudo chown -R biralo:biralo /home/biralo/vps-data
          echo "cd ~/vps-data" | sudo tee -a /home/biralo/.bashrc

      - name: Restore backup if available
        run: |
          git fetch origin backup || echo "No backup branch yet"
          git checkout backup -- latest.txt || echo "No latest.txt file yet"
          if [ -f latest.txt ]; then
            curl -sL $(cat latest.txt) | tar -xz -C /home/biralo/vps-data
            sudo chown -R biralo:biralo /home/biralo/vps-data
          else
            echo "No backup to restore"
          fi

      - name: Show Tailscale IP
        run: sudo tailscale ip -4

      - name: Start tmate session and keep alive for 5h57m
        id: tmate-session
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          ssh=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          web=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')
          echo "ssh=$ssh" >> $GITHUB_OUTPUT
          echo "web=$web" >> $GITHUB_OUTPUT
          sleep $((5*3600 + 57*60))

      - name: Backup VPS data to transfer.sh
        run: |
          tar -czf /tmp/vps-backup.tar.gz -C /home/biralo/vps-data .
          url=$(curl --upload-file /tmp/vps-backup.tar.gz https://transfer.sh/vps-backup.tar.gz)
          echo "$url" > latest.txt

      - name: Commit and push latest backup link
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git fetch origin
          git switch --force-create backup || git checkout backup
          mv latest.txt latest.txt
          git add latest.txt
          git commit -m "Update backup link $(date)"
          git push --force origin backup

      - name: Trigger next VPS run (auto rotation)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          curl -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_PAT" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"create-vps"}'

      - name: Output tmate SSH & Web link
        run: |
          echo "âœ… VPS ready!"
          echo "ğŸ” SSH: ${{ steps.tmate-session.outputs.ssh }}"
          echo "ğŸŒ Web: ${{ steps.tmate-session.outputs.web }}"

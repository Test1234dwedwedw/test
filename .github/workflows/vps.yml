name: Free VPS

on:
  repository_dispatch:
    types: [create-vps]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 357 # ~6 hours

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y tmate curl tar tailscale

      - name: Start Tailscale
        run: |
          tailscale up --authkey ${{ secrets.TS_AUTHKEY }} --hostname github-vps

      - name: Create user 'biralo' with sudo & home dir
        run: |
          sudo useradd -m -s /bin/bash biralo
          echo "biralo:biralo" | sudo chpasswd
          sudo usermod -aG sudo biralo
          echo "User 'biralo' created with password 'biralo'"

      - name: Restore backup (if exists)
        run: |
          git fetch origin backup
          git checkout backup -- latest.txt || echo "No latest.txt"
          if [ -f latest.txt ]; then
            curl -o backup.tar.gz "$(cat latest.txt)"
            mkdir -p /home/biralo/vps-data
            tar -xvzf backup.tar.gz -C /home/biralo/vps-data || echo "No backup to restore"
            chown -R biralo:biralo /home/biralo/vps-data
          fi

      - name: Start tmate session
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > ssh.txt
          tmate -S /tmp/tmate.sock display -p '#{tmate_web}' >> ssh.txt
          cat ssh.txt

      - name: Wait and let VPS run
        run: sleep 357m

      - name: Backup before exit
        run: |
          tar -czvf backup.tar.gz -C /home/biralo/vps-data .
          curl --upload-file ./backup.tar.gz https://transfer.sh/backup.tar.gz > latest.txt

      - name: Push backup to backup branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git fetch origin
          git switch --force-create backup
          mv latest.txt latest.txt
          git add latest.txt
          git commit -m "Auto backup on rotation"
          git push origin backup --force

      - name: Trigger next VPS
        run: |
          curl -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"create-vps"}'

name: VPS Auto-Rotate

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  run-vps:
    runs-on: ubuntu-latest
    steps:

      - name: ⏬ Clone repo
        uses: actions/checkout@v4

      - name: 📁 Create VPS folder
        run: mkdir -p ~/vps-data

      - name: 🧠 Restore previous backup from transfer.sh
        run: |
          wget -q https://raw.githubusercontent.com/${{ github.repository }}/backup/latest.txt -O latest.txt || echo "No previous backup"
          if [ -s latest.txt ]; then
            curl -sL $(cat latest.txt) | tar -xz -C ~/vps-data
            echo "Backup restored!"
          else
            echo "No backup found."
          fi

      - name: 🐧 Start VPS (example)
        run: |
          cd ~/vps-data
          echo "Running your VPS app here..."
          nohup bash -c 'while true; do date; sleep 30; done' > log.txt 2>&1 &

      - name: ⏳ Wait 5 hours 55 mins before backup
        run: sleep $((5 * 3600 + 55 * 60))  # 5h 55m = 21300 sec

      - name: 💾 Backup VPS data to transfer.sh
        run: |
          cd ~/vps-data
          tar -czf /tmp/vps-backup.tar.gz .
          curl --upload-file /tmp/vps-backup.tar.gz https://transfer.sh/vps-backup.tar.gz > link.txt
          LINK=$(cat link.txt)
          echo "Transfer.sh link: $LINK"
          echo "$LINK" > latest.txt

      - name: 🆙 Commit latest.txt to backup branch
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git fetch origin backup
          git checkout backup || git checkout --orphan backup
          mv latest.txt latest.txt
          git add latest.txt
          git commit -m "Updated backup link"
          git push --force origin backup

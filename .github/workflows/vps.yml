name: Free VPS with Stable Tailscale + tmate + Gofile Backup + Auto Rotation

on:
  repository_dispatch:
    types: [create-vps]
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 2  # 2 min max

    steps:
      - name: Checkout repo (for backup.txt)
        uses: actions/checkout@v4

      - name: Set hostname to Biralo
        run: sudo hostnamectl set-hostname Biralo

      - name: Create user 'biralo' with sudo
        run: |
          sudo useradd -m -s /bin/bash biralo || true
          echo "biralo:biralo" | sudo chpasswd
          echo "biralo ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/biralo
          sudo mkdir -p /home/biralo/vps-data
          sudo chown -R biralo:biralo /home/biralo/vps-data
          echo "cd ~/vps-data" | sudo tee -a /home/biralo/.bashrc

      - name: Restore backup (if exists)
        run: |
          if [ -s backup.txt ]; then
            url=$(cat backup.txt)
            echo "Restoring from $url"
            curl -L "$url" -o /tmp/backup.tar.gz
            sudo tar -xzf /tmp/backup.tar.gz -C /home/biralo/vps-data
            sudo chown -R biralo:biralo /home/biralo/vps-data
          else
            echo "No backup found"
          fi

      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y curl wget tmate jq tar git

      - name: Install Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey $TS_AUTHKEY --hostname github-vps

      - name: Show stable Tailscale IPv4
        run: sudo tailscale ip -4

      - name: Start tmate session
        id: tmate-session
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          echo "ssh=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')" >> $GITHUB_OUTPUT
          echo "web=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')" >> $GITHUB_OUTPUT
          sleep $((5*3600 + 57*60))  # Wait 5h57m

      - name: Backup /home/biralo/vps-data to Gofile.io
        id: backup
        run: |
          tar -czf /tmp/backup.tar.gz -C /home/biralo/vps-data .
          response=$(curl -s -F "file=@/tmp/backup.tar.gz" https://store1.gofile.io/uploadFile)
          url=$(echo $response | jq -r '.data.downloadPage')
          echo "$url" > backup.txt
          echo "ğŸ”— Backup URL: $url"
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Commit and push backup.txt to repo
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add backup.txt
          git commit -m "ğŸ”„ Auto backup $(date)"
          git push origin HEAD:${GITHUB_REF#refs/heads/}

      - name: Trigger next VPS run for auto rotation
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          curl -X POST -H "Authorization: Bearer $GH_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"create-vps"}'

      - name: Output SSH/Web links
        run: |
          echo "âœ… VPS is ready!"
          echo "ğŸ” SSH: ${{ steps.tmate-session.outputs.ssh }}"
          echo "ğŸŒ Web: ${{ steps.tmate-session.outputs.web }}"
